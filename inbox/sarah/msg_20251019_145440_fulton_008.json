{
  "from": "fulton",
  "to": ["sarah"],
  "subject": "CALBEAF-53 expanded - MapCenter tracking backend READY",
  "body": "Sarah,\n\nPer Gotan's request (Option B), I've added MapCenter tracking to CALBEAF-53! Backend is complete and ready.\n\n## NEW ENDPOINT - MapCenter Reset Tracking:\n\n**Endpoint**: `POST /api/user/mapcenter-track`\n**Auth**: Firebase Bearer token (logged-in users only)\n**Collection**: `MapCenterHistory` (new collection)\n\n**Purpose**: Track when logged-in users reset their MapCenter while browsing for usage pattern analytics.\n\n## FRONTEND IMPLEMENTATION:\n\n### When to Call:\nWhenever a logged-in user resets/changes their MapCenter coordinates while browsing.\n\n### Request Format:\n```javascript\nconst response = await fetch('/api/user/mapcenter-track', {\n  method: 'POST',\n  headers: {\n    'Content-Type': 'application/json',\n    'Authorization': `Bearer ${firebaseToken}`  // REQUIRED\n  },\n  body: JSON.stringify({\n    mapCenter: {\n      lat: 42.3601,   // Current MapCenter latitude\n      lng: -71.0589   // Current MapCenter longitude\n    },\n    page: window.location.pathname  // e.g., \"/calendar/boston\"\n  })\n});\n```\n\n### Response:\n```javascript\n{\n  \"success\": true,\n  \"data\": {\n    \"trackingId\": \"507f1f77bcf86cd799439011\",\n    \"timestamp\": \"2025-10-19T19:05:00Z\"\n  }\n}\n```\n\n### Error Handling:\n- 401: Not authenticated (missing/invalid Firebase token)\n- 400: Missing mapCenter or invalid lat/lng\n- 500: Server error\n\n## WHAT GETS STORED:\n\n**MapCenterHistory collection**:\n```javascript\n{\n  firebaseUserId: \"abc123...\",\n  timestamp: ISODate(\"2025-10-19...\"),\n  mapCenter: {\n    latitude: 42.3601,\n    longitude: -71.0589\n  },\n  page: \"/calendar/boston\",\n  userAgent: \"Mozilla/5.0...\",\n  deviceType: \"desktop\",\n  createdAt: ISODate(\"2025-10-19...\")\n}\n```\n\n## CALBEAF-53 NOW INCLUDES:\n\n1. ✅ UserLoginAnalytics IP field fix (completed - commit 9462ca8)\n2. ✅ MapCenter reset tracking (completed - commit dd84e39)\n3. ⏳ Visitor page parameter (you're adding to frontend)\n\n## YOUR ACTION ITEMS:\n\n**Visitor Tracking** (TIEMPO-323):\n- Add `page: window.location.pathname` to visitor tracking call\n\n**MapCenter Tracking** (NEW - TIEMPO-323):\n- Detect when user resets MapCenter\n- Call `/api/user/mapcenter-track` endpoint\n- Include Firebase auth token\n- Send mapCenter coordinates and current page\n\n## TESTING WHEN DEPLOYED:\n\nOnce I deploy to TEST:\n1. Login as user\n2. Browse to /calendar/boston\n3. Reset MapCenter to different coordinates\n4. Check TEST database for new MapCenterHistory document\n5. Verify all fields populated correctly\n\nLet me know if you have questions about the implementation!\n\n— Fulton\n\nP.S. Waiting for Gotan's approval before deploying to TEST. More features may be coming.",
  "ticket": "CALBEAF-53",
  "priority": "normal",
  "timestamp": "2025-10-19T19:05:00Z",
  "in_reply_to": "msg_20251019_144843_sarah_001"
}
