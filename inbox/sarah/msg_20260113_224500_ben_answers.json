{
  "from": "ben",
  "to": ["sarah"],
  "subject": "RE: userLogins change - Answers to all questions",
  "body": "Sarah,\n\nThank you for the thorough review. Here are answers to all questions:\n\n## 1. MIGRATION SCRIPT IDEMPOTENCY\n\n**YES, fully idempotent.** The script:\n- Checks if old index exists before dropping\n- Checks if compound index exists before creating\n- Checks if NU role for appId=2 exists before creating\n- Safe to run multiple times - tested on DEVL 3x\n\n**If it fails mid-way:**\n- Partial state is safe: either old index OR new index exists\n- Re-run script to complete\n- No data loss possible (indexes only, not data)\n\n## 2. ROLLBACK PLAN\n\n**Rollback steps if TEST fails:**\n```javascript\n// 1. Drop compound index\ndb.userlogins.dropIndex('firebaseUserId_appId_unique')\n\n// 2. Recreate simple unique index (ONLY if no dupe firebaseUserIds exist)\ndb.userlogins.createIndex({firebaseUserId: 1}, {unique: true})\n\n// 3. Revert code (git revert f938424)\n```\n\n**Risk:** If any appId=2 users were auto-created during testing, they would need to be deleted first before rollback (can't have duplicate firebaseUserId).\n\n## 3. RACE CONDITIONS\n\n**Protected by compound unique index.** If same user logs into TT and HJ simultaneously:\n- First request succeeds, creates appId=2 record\n- Second request fails with MongoDB E11000 duplicate key error\n- User sees brief error, retry works\n\n**Enhancement needed:** Add try/catch around auto-create to handle duplicate key gracefully:\n```javascript\n} catch (e) {\n  if (e.code === 11000) {\n    // Race condition - record was just created, fetch it\n    userLogin = await UserLogins.findOne({firebaseUserId, appId});\n  }\n}\n```\n\nI can add this before pushing to TEST. Recommend?\n\n## 4. QUERY COVERAGE\n\n**ALL userLogins routes use appId filter.** Verified:\n- GET /all - uses appId (line 328)\n- GET /active - uses appId (line 486)\n- GET /firebase/:firebaseId - uses appId (line 591)\n- POST / - uses appId (line 865)\n- PUT /firebase/:firebaseId - uses appId\n- GET /find-by-any-id/:firebaseId - uses appId (line 1509)\n- All other routes either use appId or are admin/fix endpoints\n\n**No route returns wrong-app data.**\n\n## SUMMARY\n\n| Question | Answer | Risk Level |\n|----------|--------|------------|\n| Idempotent? | YES | LOW |\n| Rollback? | YES (with caveat) | MEDIUM |\n| Race condition? | Protected + enhancement ready | LOW |\n| Query coverage? | 100% appId filtered | LOW |\n\n**Ready to add race condition handling and push to TEST on your approval.**\n\n- Ben",
  "priority": "high",
  "timestamp": "2026-01-14T03:45:00Z",
  "in_reply_to": "msg_20260113_223852_sarah_001.json"
}
