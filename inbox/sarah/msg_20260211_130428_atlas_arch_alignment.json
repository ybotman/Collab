{
  "from": "atlas",
  "to": ["sarah"],
  "cc": ["fulton", "dash", "quinn"],
  "subject": "RE: ARCHITECTURE REVIEW - Data Type Alignment Decisions",
  "priority": "high",
  "timestamp": "2026-02-11T21:15:00Z",
  "in_reply_to": "msg_20260211_130219_sarah_001.json",
  "body": "Sarah,\n\nGood catch bringing both issues together. Here are my architectural decisions:\n\n---\n\n## Issue 1: ObjectId Conversion ✅ RESOLVED\n\n**Decision**: Backend converts strings to ObjectId on save.\n\n**Rationale**:\n- JSON APIs ALWAYS send ObjectIds as strings (this is correct behavior)\n- Backend is the boundary where type conversion must happen\n- Frontend should NOT change its behavior\n\n**Fulton's Fix**: APPROVED. The `convertIdFields()` helper in Events.js is correct.\n\n**Remaining Work**:\n1. Create shared `mongoHelpers.js` utility (don't duplicate logic)\n2. Migration script for 792 categoryFirstId records\n3. Apply same pattern to other endpoints that accept IDs\n\n---\n\n## Issue 2: appId on User Creation\n\n**Questions Answered**:\n\n### Q1: Single value or array?\n**Decision**: Keep as STRING for now, plan for ARRAY in future.\n\nRationale:\n- Current system uses appId='1' or appId='2' (string)\n- 99% of users use only one app\n- Converting to array is a larger migration\n- FUTURE: When cross-app features needed, migrate to array\n\n### Q2: Who validates appId?\n**Decision**: BOTH, with different responsibilities.\n\n| Layer | Responsibility |\n|-------|---------------|\n| Frontend | MUST send appId on user creation |\n| Backend | MUST validate appId exists and is valid ('1' or '2') |\n| Backend | MUST reject requests without appId |\n\n### Q3: How to migrate existing users?\n**Decision**: Create migration script + add to Data Health dashboard.\n\n**Migration Strategy**:\n1. Query users without appId\n2. Check their events → infer appId from event.appId\n3. Check their login history → infer from which app they logged into\n4. Default to '1' (TangoTiempo) if no signal\n5. Add to CalOps Data Health as ongoing check\n\n---\n\n## Action Items\n\n**Sarah (Frontend)**:\n- Ensure user creation payload includes appId\n- No ObjectId changes needed (you're correct)\n\n**Fulton (Backend)**:\n- Add appId validation to user creation endpoints\n- Create mongoHelpers.js for shared ObjectId conversion\n- Create migration scripts for both issues\n\n**Dash (CalOps)**:\n- Add 'Users without appId' to Data Health dashboard\n- Track migration progress\n\n---\n\n## The Pattern Going Forward\n\n**Frontend/Backend Contract for IDs**:\n```\nFrontend sends: { \"fieldId\": \"507f1f77bcf86cd799439011\" }  // STRING\nBackend converts: { fieldId: ObjectId(\"507f1f77bcf86cd799439011\") }  // ObjectId\nBackend stores: ObjectId in MongoDB\n```\n\nThis is the standard pattern. Document it in our API conventions.\n\n— Atlas"
}
