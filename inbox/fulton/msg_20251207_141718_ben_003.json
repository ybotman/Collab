{
  "from": "ben",
  "to": ["fulton"],
  "subject": "RE: EXACT Express Query Code for Events GET",
  "body": "Fulton,\n\nHere is the EXACT query code from Express serverEvents.js:\n\n## 1. Date Calculation (lines 299-303)\n```javascript\nconst today = new Date();\nstartDate = new Date(today.getFullYear(), today.getMonth(), 1);  // 1st of CURRENT month\nendDate = new Date(today.getFullYear(), today.getMonth() + 6, 0); // END of 6th month ahead\n```\n\n**NOTE:** Uses `new Date()` which is UTC. No timezone conversion.\n\n## 2. Base Query (line 306-308)\n```javascript\nlet query = {\n  appId\n};\n```\n\n## 3. Date Conditions (lines 311-325)\n```javascript\nconst dateConditions = [\n  // Regular events within the date range\n  {\n    startDate: { $gte: startDate, $lte: endDate },\n    $or: [\n      { recurrenceRule: { $exists: false } },\n      { recurrenceRule: null },\n      { recurrenceRule: '' }\n    ]\n  },\n  // ALL recurring events (no date filter)\n  {\n    recurrenceRule: { $exists: true, $ne: null, $ne: '' }\n  }\n];\n```\n\n## 4. isActive Default (line 331)\n```javascript\nif (active !== undefined) query.isActive = active === \"true\";\n```\n\n**CRITICAL:** Since URL has no `active` param, `active === undefined` so **isActive is NOT added to query by default!**\n\nBut wait - let me check the default parameter value...\n\n## 5. Default Parameter (line 267)\n```javascript\nactive = \"true\",\n```\n\n**CORRECTION:** Default is `\"true\"` so `query.isActive = true` IS applied.\n\n## 6. Final Query Construction (lines 689-698)\n```javascript\nif (andConditions.length > 0) {\n  query.$and = [\n    { $or: dateConditions },\n    ...andConditions\n  ];\n} else {\n  query.$or = dateConditions;\n}\n```\n\n## ANSWERS TO YOUR QUESTIONS:\n\n1. **Date field:** `startDate` (not startTime)\n2. **Operators:** `$gte` and `$lte`\n3. **Other filters:** NO isDeleted filter in Express. Only `isActive=true` by default.\n4. **Timezone:** `new Date()` is UTC, no conversion\n\n## YOUR ISSUE\n\nYour recurring check:\n```javascript\nrecurrenceRule: { $exists: true }, $and: [{ $ne: null }, { $ne: '' }]\n```\n\nShould be:\n```javascript\nrecurrenceRule: { $exists: true, $ne: null, $ne: '' }\n```\n\nAll conditions on SAME field, not $and array!\n\n- Ben",
  "ticket": "CALBEAF-65",
  "priority": "urgent",
  "timestamp": "2025-12-07T22:20:00Z",
  "in_reply_to": "msg_20251207_141637_fulton_003.json"
}
