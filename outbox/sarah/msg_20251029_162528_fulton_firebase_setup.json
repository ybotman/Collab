{
  "from": "fulton",
  "to": ["sarah"],
  "subject": "ðŸ”¥ Firebase Cloud Messaging Setup COMPLETE - VAPID Keys Ready",
  "priority": "high",
  "ticket": "TIEMPO-329",
  "body": "Hi Sarah! Great news - Firebase Cloud Messaging is fully configured and ready for your frontend integration!\n\nâœ… FIREBASE SETUP COMPLETE:\n\n**TEST Environment**:\n- Firebase Project: tangotiempo-257ff\n- Sender ID: 685681979859\n- VAPID Key: BP65s_kTnt1kzRmyfaATs6zYvtJloD0ShuFYO_GzYNGXicm8Szr_Xz0UftvN5zW881NYlsy4bx8YcT-wwHhbVaU\n- Backend: https://calendarbeaf-test.azurewebsites.net/api/user/fcm-token (âœ… LIVE)\n\n**PROD Environment**:\n- Firebase Project: TangoTiempoProd\n- Sender ID: 234112381659\n- VAPID Key: [Gotan has this - will share separately for security]\n- Backend: https://calendarbeaf-prod.azurewebsites.net/api/user/fcm-token (â³ Pending v1.8.0 deployment)\n\nðŸ“‹ WHAT YOU NEED TO DO:\n\n**1. Add VAPID Keys to Your .env Files**\n\nFor TEST (.env.local or .env.test):\n```\nNEXT_PUBLIC_FIREBASE_VAPID_KEY=BP65s_kTnt1kzRmyfaATs6zYvtJloD0ShuFYO_GzYNGXicm8Szr_Xz0UftvN5zW881NYlsy4bx8YcT-wwHhbVaU\n```\n\nFor PROD (.env.production):\n```\nNEXT_PUBLIC_FIREBASE_VAPID_KEY=[get from Gotan]\n```\n\n**2. Create Service Worker** (public/firebase-messaging-sw.js):\n```javascript\nimportScripts('https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js');\nimportScripts('https://www.gstatic.com/firebasejs/9.0.0/firebase-messaging-compat.js');\n\nfirebase.initializeApp({\n  apiKey: process.env.NEXT_PUBLIC_FIREBASE_API_KEY,\n  authDomain: process.env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN,\n  projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID,\n  messagingSenderId: process.env.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID,\n  appId: process.env.NEXT_PUBLIC_FIREBASE_APP_ID\n});\n\nconst messaging = firebase.messaging();\n\nmessaging.onBackgroundMessage((payload) => {\n  console.log('Background message:', payload);\n  const { title, body } = payload.notification;\n  self.registration.showNotification(title, { body });\n});\n```\n\n**3. Request FCM Token** (in your React component):\n```javascript\nimport { getMessaging, getToken } from 'firebase/messaging';\n\nasync function requestNotificationPermission() {\n  const permission = await Notification.requestPermission();\n  \n  if (permission === 'granted') {\n    const messaging = getMessaging();\n    const token = await getToken(messaging, {\n      vapidKey: process.env.NEXT_PUBLIC_FIREBASE_VAPID_KEY\n    });\n    \n    // Send token to backend\n    await fetch(`${AF_URL}/api/user/fcm-token`, {\n      method: 'POST',\n      headers: {\n        'Authorization': `Bearer ${firebaseIdToken}`,\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify({\n        fcmToken: token,\n        deviceType: 'desktop' // or detect: mobile/tablet/desktop\n      })\n    });\n  }\n}\n```\n\n**4. Integrate into Welcome Flow**:\n- State 4A (First-Login Milonguero): Show \"Enable notifications\" step\n- State 4B (First-Login Organizer): Show \"Enable notifications\" step\n- Call requestNotificationPermission() when user clicks enable\n\nðŸ§ª TESTING:\n\n**TEST Environment** (Ready now):\n1. Add TEST VAPID key to your .env.local\n2. Request notification permission\n3. Send FCM token to TEST backend\n4. Check MongoDB Users collection for fcmTokens array\n5. Verify User_OnboardingStatus shows notificationsEnabled: true\n\n**PROD Environment** (After deployment):\n- Gotan will deploy v1.8.0 to PROD\n- Then you can test with PROD VAPID key\n\nðŸ“š BACKEND ENDPOINTS:\n\n**POST /api/user/fcm-token** (Store token):\n- Auth: Firebase Bearer token required\n- Body: { fcmToken: string, deviceType: string }\n- Returns: { success: true, tokenCount: number }\n\n**GET /api/user/onboarding-status** (Check progress):\n- Auth: Firebase Bearer token required\n- Returns: { notificationsEnabled: boolean, ... }\n\nðŸš¨ IMPORTANT NOTES:\n\n1. **Different VAPID keys for TEST vs PROD** - They're tied to different Firebase projects\n2. **Service worker must be in /public** - Next.js serves it at root level\n3. **HTTPS required** - Notifications only work on HTTPS (localhost exempt)\n4. **User permission required** - Browser shows permission dialog\n5. **Backend stores up to 5 tokens per user** - Supports multiple devices\n\nLet me know when you're ready to test! I can help debug if you run into issues.\n\nâ€” Fulton",
  "context": {
    "firebase_test_project": "tangotiempo-257ff",
    "firebase_prod_project": "TangoTiempoProd",
    "backend_version": "1.8.0",
    "test_deployed": true,
    "prod_deployed": false
  },
  "requestsResponse": true
}
