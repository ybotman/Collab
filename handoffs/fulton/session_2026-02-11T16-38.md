# Session Handoff: Fulton @ 2026-02-11T16:30

## Current Status
Two bugs fixed: String→ObjectId (deployed PROD), User location (data fix applied). Awaiting Atlas decision on userDefaults deprecation.

## Active Ticket
- **Ticket**: None formally created (should create CALBEAF-XXX)
- **Status**: completed (immediate fixes), pending (architecture decision)

## What I Did This Session

### Bug 1: String vs ObjectId in Event CRUD
- **Root cause**: Azure Functions backend saved ID fields as strings instead of ObjectId
- **Impact**: Organizers couldn't see their events (ownerOrganizerID, venueID queries failed)
- **Fix**: Added `convertIdFields()` helper to Events.js (commit 45e223a9)
- **Deployed**: DEVL → TEST → PROD ✅
- **Manual fixes**: 10 events fixed in PROD (Simonida, Elana, Milton, Roger)

### Bug 2: Users can't see events when logged in
- **Root cause**: Two location systems - `userDefaults` (old) vs `mapCenter` (new)
- **Impact**: 12 users with mapCenter but no userDefaults were blocked by frontend gate check
- **Affected users**: Elana, Simonida, Keith, Roger, Fidan, Hsueh-tze + 6 others
- **Fix**: Added `userDefaults` + set `mapCenter` to MA center (42.4072, -71.3824, 200mi) for 11 users
- **Elana**: Fixed separately
- **Sarah's fix**: bd5df9a - adds mapCenter as fallback (not yet deployed to PROD?)

### Architecture Analysis
- `userDefaults` contains only 2 dead fields: `defaultZoomRange`, `useCenterLocation`
- FE only checks if object EXISTS, never reads values
- Recommendation: Consolidate to `mapCenter` only
- Sent to Atlas for decision

## Messages Sent
- Broadcast: String→ObjectId fix summary + deployment plan
- Sarah: TEST deployment details
- Broadcast: 11 users fixed with mapCenter
- Atlas: userDefaults deprecation architecture question
- Broadcast: userDefaults audit (only 2 dead fields)

## Next Session Should
1. Check Atlas response on userDefaults deprecation
2. Verify Keith/Simonida can see events (they were complaining)
3. Confirm Sarah's fix deployed to PROD
4. Clarify: Does Sarah's fix fully use mapCenter, or just fallback?
5. Create JIRA ticket for this work if needed

## Key Decisions Made
- Used shared helper (not middleware) for ID conversion - per Atlas
- Set 11 users to MA center with 200mi radius - quick fix
- Did NOT deprecate userDefaults yet - awaiting Atlas

## Context for Future Me
- Database names: TangoTiempo=TEST, TangoTiempoProd=PROD (case sensitive!)
- categoryFirstId STRING issue (792 events) is LOW priority - FE uses name not ID
- Duplicate events exist (BTC import vs organizer created) - separate issue
- TRANOCHANDO missing March 2026 - data gap, not code bug
- Sarah's fix (bd5df9a) is fallback, FE still checks userDefaults first
- Goal: Consolidate to mapCenter only, remove userDefaults check

## Open Questions
1. Should we fully deprecate userDefaults? (Atlas decision pending)
2. Did Sarah's fix deploy to PROD?
3. Does Sarah's fix fully switch to mapCenter or just add fallback?
